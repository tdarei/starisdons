<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Gemini Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px 5px;
        }
        button:hover { background: #45a049; }
        #output {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            min-height: 100px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
    </style>
</head>
<body>
    <h1>ðŸ§ª Gemini Live API Quick Test</h1>
    <p>Testing with API key: [REDACTED]</p>
    
    <button onclick="testREST()">Test REST API (gemini-2.5-flash-live-preview)</button>
    <button onclick="testStreaming()">Test Streaming (gemini-2.5-flash-live)</button>
    <button onclick="testWebSocket()">Test WebSocket (gemini-2.5-flash-live)</button>
    
    <div id="output"></div>

    <script>
        const API_KEY = new URLSearchParams(window.location.search).get('key') || localStorage.getItem('GOOGLE_API_KEY') || '';
        const TEST_PROMPT = 'Say "Hello! The API is working!" if you can read this.';

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function testREST() {
            clearOutput();
            log('ðŸŒ Testing REST API with gemini-2.5-flash-live-preview...', 'info');
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-live-preview:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: TEST_PROMPT }] }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1024
                            }
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const data = await response.json();
                const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
                
                log(`âœ… SUCCESS! Response: "${responseText}"`, 'success');
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testStreaming() {
            clearOutput();
            log('ðŸŒŠ Testing REST Streaming with gemini-2.5-flash-live...', 'info');
            
            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-live:streamGenerateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: TEST_PROMPT }] }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1024
                            }
                        })
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`âŒ HTTP ${response.status}: ${errorText}`, 'error');
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                log('ðŸ“¡ Receiving stream...', 'info');
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                if (text) {
                                    fullResponse += text;
                                    log(`ðŸ“ Chunk: "${text}"`, 'info');
                                }
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                log(`âœ… SUCCESS! Full response: "${fullResponse}"`, 'success');
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        async function testWebSocket() {
            clearOutput();
            log('ðŸ“¡ Testing WebSocket with gemini-2.5-flash-live...', 'info');
            
            try {
                const wsUrl = `wss://generativelanguage.googleapis.com/ws/google.cloud.aiplatform.v1beta1.LlmBidiService/BidiGenerateContent?key=${API_KEY}`;
                
                return new Promise((resolve, reject) => {
                    const ws = new WebSocket(wsUrl);
                    let responseText = '';
                    let setupComplete = false;
                    const timeout = setTimeout(() => {
                        ws.close();
                        log('âŒ WebSocket timeout after 30 seconds', 'error');
                        reject(new Error('Timeout'));
                    }, 30000);

                    ws.onopen = () => {
                        log('âœ… WebSocket connected', 'success');
                        
                        const setupMessage = {
                            setup: {
                                model: 'models/gemini-2.5-flash-live',
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 1024,
                                    responseModalities: ["TEXT"]
                                }
                            }
                        };
                        ws.send(JSON.stringify(setupMessage));
                        log('ðŸ“¤ Setup message sent', 'info');
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            
                            if (data.setupComplete) {
                                log('âœ… Setup complete', 'success');
                                setupComplete = true;
                                
                                const clientMessage = {
                                    clientContent: {
                                        parts: [{ text: TEST_PROMPT }]
                                    }
                                };
                                ws.send(JSON.stringify(clientMessage));
                                log('ðŸ“¤ Client message sent', 'info');
                            } else if (data.serverContent) {
                                // Official format: check parts directly first
                                if (data.serverContent.parts && Array.isArray(data.serverContent.parts)) {
                                    data.serverContent.parts.forEach(part => {
                                        if (part.text) {
                                            responseText += part.text;
                                            log(`ðŸ“ Received: "${part.text}"`, 'info');
                                        }
                                    });
                                }
                                // Fallback to modelTurn format
                                else if (data.serverContent.modelTurn && data.serverContent.modelTurn.parts) {
                                    const parts = data.serverContent.modelTurn.parts || [];
                                    parts.forEach(part => {
                                        if (part.text) {
                                            responseText += part.text;
                                            log(`ðŸ“ Received: "${part.text}"`, 'info');
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            log(`âŒ Error parsing message: ${error.message}`, 'error');
                        }
                    };

                    ws.onerror = (error) => {
                        clearTimeout(timeout);
                        log(`âŒ WebSocket error: ${error.message || 'Unknown error'}`, 'error');
                        reject(error);
                    };

                    ws.onclose = () => {
                        clearTimeout(timeout);
                        if (responseText) {
                            log(`âœ… SUCCESS! Response: "${responseText}"`, 'success');
                            resolve(responseText);
                        } else if (!setupComplete) {
                            log('âŒ WebSocket closed before setup complete', 'error');
                            reject(new Error('Closed before setup'));
                        } else {
                            log(responseText ? `âœ… Response: "${responseText}"` : 'âš ï¸ No response text received', responseText ? 'success' : 'error');
                            resolve(responseText || '');
                        }
                    };
                });
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }

        // Auto-run REST test on load
        window.addEventListener('load', () => {
            log('ðŸš€ Page loaded. Click a button to test!', 'info');
        });
    </script>
</body>
</html>

