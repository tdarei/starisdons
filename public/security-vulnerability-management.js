/**
 * Security Vulnerability Management
 * Vulnerability tracking and remediation management
 */

class SecurityVulnerabilityManagement {
    constructor() {
        this.vulnerabilities = new Map();
        this.assets = new Map();
        this.remediations = new Map();
        this.init();
    }

    init() {
        this.trackEvent('s_ec_ur_it_yv_ul_ne_ra_bi_li_ty_ma_na_ge_me_nt_initialized');
    }

    trackEvent(eventName, data = {}) {
        try {
            if (typeof window !== 'undefined' && window.performanceMonitoring) {
                window.performanceMonitoring.recordMetric("s_ec_ur_it_yv_ul_ne_ra_bi_li_ty_ma_na_ge_me_nt_" + eventName, 1, data);
            }
        } catch (e) { /* Silent fail */ }
    }


    registerVulnerability(vulnId, vulnData) {
        const vulnerability = {
            id: vulnId,
            ...vulnData,
            cve: vulnData.cve || '',
            severity: vulnData.severity || 'medium',
            cvss: vulnData.cvss || 0,
            affectedAssets: vulnData.affectedAssets || [],
            status: 'open',
            createdAt: new Date()
        };
        
        this.vulnerabilities.set(vulnId, vulnerability);
        console.log(`Vulnerability registered: ${vulnId}`);
        return vulnerability;
    }

    registerAsset(assetId, assetData) {
        const asset = {
            id: assetId,
            ...assetData,
            name: assetData.name || assetId,
            type: assetData.type || '',
            vulnerabilities: assetData.vulnerabilities || [],
            createdAt: new Date()
        };
        
        this.assets.set(assetId, asset);
        console.log(`Asset registered: ${assetId}`);
        return asset;
    }

    assignVulnerabilityToAsset(vulnId, assetId) {
        const vulnerability = this.vulnerabilities.get(vulnId);
        const asset = this.assets.get(assetId);
        
        if (!vulnerability) {
            throw new Error('Vulnerability not found');
        }
        if (!asset) {
            throw new Error('Asset not found');
        }
        
        if (!vulnerability.affectedAssets.includes(assetId)) {
            vulnerability.affectedAssets.push(assetId);
        }
        
        if (!asset.vulnerabilities.includes(vulnId)) {
            asset.vulnerabilities.push(vulnId);
        }
        
        return { vulnerability, asset };
    }

    createRemediation(vulnId, remediationData) {
        const vulnerability = this.vulnerabilities.get(vulnId);
        if (!vulnerability) {
            throw new Error('Vulnerability not found');
        }
        
        const remediation = {
            id: `remediation_${Date.now()}`,
            vulnId,
            ...remediationData,
            plan: remediationData.plan || '',
            status: 'planned',
            targetDate: remediationData.targetDate ? new Date(remediationData.targetDate) : null,
            createdAt: new Date()
        };
        
        this.remediations.set(remediation.id, remediation);
        vulnerability.remediationId = remediation.id;
        
        return remediation;
    }

    completeRemediation(remediationId) {
        const remediation = this.remediations.get(remediationId);
        if (!remediation) {
            throw new Error('Remediation not found');
        }
        
        remediation.status = 'completed';
        remediation.completedAt = new Date();
        
        const vulnerability = this.vulnerabilities.get(remediation.vulnId);
        if (vulnerability) {
            vulnerability.status = 'resolved';
            vulnerability.resolvedAt = new Date();
        }
        
        return remediation;
    }

    getVulnerabilitiesBySeverity(severity) {
        return Array.from(this.vulnerabilities.values())
            .filter(v => v.severity === severity);
    }

    getAsset(assetId) {
        return this.assets.get(assetId);
    }

    getVulnerability(vulnId) {
        return this.vulnerabilities.get(vulnId);
    }
}

// Auto-initialize and export
if (typeof window !== 'undefined') {
    window.securityVulnerabilityManagement = new SecurityVulnerabilityManagement();
}
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SecurityVulnerabilityManagement;
}


