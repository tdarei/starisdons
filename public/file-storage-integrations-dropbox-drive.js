/**
 * File Storage Integrations (Dropbox, Drive)
 * Integrates with Dropbox and Google Drive for file storage
 * 
 * ⚠️ SECURITY WARNING ⚠️
 * NEVER hardcode your `accessToken` or `clientSecret` in this file or any frontend code.
 * Doing so will allow attackers to access your users' files.
 * Always fetch tokens from a secure backend or use implicit OAuth flow.
 * 
 * IMPORTANT: If you are using this file in a client-side application, you MUST NOT
 * store long-lived credentials here. Any token exposed in client-side code is visible
 * to the user. Use short-lived ephemeral tokens generated by a backend service.
 */

class FileStorageIntegrations {
    constructor() {
        this.providers = new Map();
        this.init();
    }

    init() {
        this.trackEvent('f_il_es_to_ra_ge_in_te_gr_at_io_ns_initialized');
    }

    trackEvent(eventName, data = {}) {
        try {
            if (typeof window !== 'undefined' && window.performanceMonitoring) {
                window.performanceMonitoring.recordMetric("f_il_es_to_ra_ge_in_te_gr_at_io_ns_" + eventName, 1, data);
            }
        } catch (e) { /* Silent fail */ }
    }


    configureProvider(provider, config) {
        this.providers.set(provider, config);
    }

    async uploadFile(provider, file, path) {
        const config = this.providers.get(provider);
        if (!config) {
            throw new Error(`${provider} not configured`);
        }

        if (provider === 'dropbox') {
            return await this.uploadToDropbox(file, path, config);
        } else if (provider === 'drive') {
            return await this.uploadToDrive(file, path, config);
        }
    }

    async uploadToDropbox(file, path, config) {
        const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${config.accessToken}`,
                'Dropbox-API-Arg': JSON.stringify({ path }),
                'Content-Type': 'application/octet-stream'
            },
            body: file
        });

        if (!response.ok) {
            throw new Error(`Dropbox upload failed: ${response.statusText}`);
        }

        return await response.json();
    }

    async uploadToDrive(file, path, config) {
        const metadata = {
            name: path.split('/').pop(),
            parents: [config.folderId]
        };

        const formData = new FormData();
        formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        formData.append('file', file);

        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${config.accessToken}`
            },
            body: formData
        });

        if (!response.ok) {
            throw new Error(`Google Drive upload failed: ${response.statusText}`);
        }

        return await response.json();
    }
}

// Auto-initialize
const fileStorageIntegrations = new FileStorageIntegrations();

// Export for module systems
if (typeof module !== 'undefined' && module.exports) {
    module.exports = FileStorageIntegrations;
}
